<div class="register-page">

  <!-- Navbar -->
  <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-[#EDE8DF]"
       style="box-shadow:0 1px 12px rgba(30,26,22,0.05)">
    <div class="max-w-6xl mx-auto px-6 h-[64px] flex items-center justify-between">
      <a routerLink="/" class="flex items-center gap-3 group">
        <img src="assets/images/logo.png" alt="Digital Is Yours"
             class="h-9 w-auto object-contain group-hover:scale-105 transition-transform"/>
      </a>
      <a routerLink="/login"
         class="text-sm font-semibold flex items-center gap-1.5 hover:underline"
         style="color:#8B3A3A">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"/>
        </svg>
        Retour à la connexion
      </a>
    </div>
  </nav>

  <div class="flex-1 flex items-start justify-center py-10 px-4">
    <div class="w-full max-w-[480px]">

      <!-- ══ ÉTAPE 1 : EMAIL ══ -->
      <div *ngIf="currentStep === 1" class="register-card">
        <div class="text-center mb-8">
          <img src="assets/images/logo.png" alt="DIY" class="h-10 w-auto object-contain mx-auto mb-6"/>
          <div class="w-16 h-16 rounded-2xl mx-auto mb-5 flex items-center justify-center"
               style="background:linear-gradient(135deg,#f9f0f0,#f5d5d5)">
            <svg class="w-8 h-8" fill="none" stroke="#8B3A3A" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <h1 class="font-display font-bold text-[#1E1A16] mb-2" style="font-size:clamp(24px,4vw,32px)">
            Mot de passe oublié ?
          </h1>
          <p class="text-[#6B5F52] text-sm leading-relaxed">
            Entrez votre adresse email et nous vous enverrons un code de réinitialisation.
          </p>
        </div>

        <div *ngIf="errorMessage" class="error-banner mb-5">
          <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          {{ errorMessage }}
        </div>

        <form [formGroup]="emailForm">
        <div class="form-group mb-6">
          <label class="form-label">Adresse email</label>
          <div class="input-wrapper">
            <span class="input-icon">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
            </span>
            <input type="email" class="form-input" placeholder="votre@email.com"
                   formControlName="email"
                   (keyup.enter)="sendOtp()"/>
          </div>
        </div>
        </form>

        <button class="btn-full btn-bordeaux" (click)="sendOtp()" [disabled]="isLoading">
          <div *ngIf="isLoading" class="spinner"></div>
          <ng-container *ngIf="!isLoading">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            Envoyer le code
          </ng-container>
        </button>
      </div>

      <!-- ══ ÉTAPE 2 : SAISIE DU CODE ══ -->
      <div *ngIf="currentStep === 2" class="register-card">
        <div class="text-center mb-7">
          <img src="assets/images/logo.png" alt="DIY" class="h-10 w-auto object-contain mx-auto mb-6"/>
          <div class="w-16 h-16 rounded-2xl mx-auto mb-5 flex items-center justify-center"
               style="background:linear-gradient(135deg,#edf4f4,#d4eaeb)">
            <svg class="w-8 h-8" fill="none" stroke="#4A7C7E" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <h1 class="font-display font-bold text-[#1E1A16] mb-2" style="font-size:clamp(22px,4vw,30px)">
            Entrez le code reçu
          </h1>
          <p class="text-[#6B5F52] text-sm">Code envoyé à <strong>{{ emailForm.value.email }}</strong></p>
        </div>

        <div *ngIf="errorMessage" class="error-banner mb-5">
          <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          {{ errorMessage }}
        </div>

        <!-- Inputs OTP -->
        <div class="otp-grid my-6" (paste)="onOtpPaste($event)">
          <input *ngFor="let val of otpValues; let i = index"
                 [id]="'fp-otp-' + i"
                 class="otp-input"
                 [class.filled]="otpValues[i] !== ''"
                 [value]="otpValues[i]"
                 type="text" inputmode="numeric" maxlength="1"
                 autocomplete="one-time-code"
                 (input)="onOtpInput($event, i)"
                 (keydown)="onOtpKeydown($event, i)"/>
        </div>

        <!-- Timer -->
        <div class="text-center mb-5">
          <div class="inline-flex items-center gap-2 text-sm mb-3">
            <svg class="w-4 h-4" fill="none" stroke="#9B8B6E" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="text-[#6B5F52]">Expire dans :</span>
            <span class="font-bold font-display text-base"
                  [style.color]="countdown < 60 ? '#c0392b' : '#9B8B6E'">
              {{ countdownDisplay }}
            </span>
          </div>
          <div>
            <button (click)="resendCode()" [disabled]="!canResend"
                    class="text-sm font-semibold transition-colors"
                    style="background:none; border:none; cursor:pointer"
                    [style.color]="canResend ? '#8B3A3A' : '#C8BEB2'"
                    [style.cursor]="canResend ? 'pointer' : 'not-allowed'">
              Renvoyer le code
            </button>
            <span *ngIf="!canResend" class="text-[#C8BEB2] text-sm">
              (disponible dans {{ countdownDisplay }})
            </span>
          </div>
        </div>

        <!-- Bouton vérifier -->
        <button class="btn-full btn-bordeaux" [disabled]="otpValues.join('').length !== 6 || isLoading"
                (click)="verifyCode()">
          <div *ngIf="isLoading" class="spinner"></div>
          <ng-container *ngIf="!isLoading">
            Vérifier le code
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </ng-container>
        </button>

        <button (click)="goToLogin()"
                class="w-full text-center text-sm text-[#9E9082] hover:text-[#8B3A3A] mt-4
                       transition-colors flex items-center justify-center gap-1.5"
                style="background:none; border:none; cursor:pointer">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"/>
          </svg>
          Retour
        </button>
      </div>

      <!-- ══ ÉTAPE 3 : NOUVEAU MOT DE PASSE ══ -->
      <div *ngIf="currentStep === 3" class="register-card">
        <div class="text-center mb-7">
          <img src="assets/images/logo.png" alt="DIY" class="h-10 w-auto object-contain mx-auto mb-6"/>
          <div class="w-16 h-16 rounded-2xl mx-auto mb-5 flex items-center justify-center"
               style="background:linear-gradient(135deg,#f9f0f0,#f5d5d5)">
            <svg class="w-8 h-8" fill="none" stroke="#8B3A3A" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
            </svg>
          </div>
          <h1 class="font-display font-bold text-[#1E1A16] mb-2" style="font-size:clamp(22px,4vw,30px)">
            Nouveau mot de passe
          </h1>
          <p class="text-[#6B5F52] text-sm">Choisissez un nouveau mot de passe sécurisé</p>
        </div>

        <div *ngIf="errorMessage" class="error-banner mb-5">
          <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          {{ errorMessage }}
        </div>

        <form [formGroup]="passwordForm">
        <!-- Nouveau mot de passe -->
        <div class="form-group">
          <label class="form-label">Nouveau mot de passe</label>
          <div class="input-wrapper">
            <span class="input-icon">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
            </span>
            <input [type]="showNewPassword ? 'text' : 'password'" class="form-input"
                   placeholder="Minimum 8 caractères"
                   formControlName="newPassword"
                   [class.error]="isInvalid('newPassword')"/>
            <button type="button" class="eye-btn" (click)="showNewPassword = !showNewPassword">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
          </div>
          <span *ngIf="isInvalid('newPassword')" class="error-msg">Minimum 8 caractères</span>
        </div>

        <!-- Confirmer mot de passe -->
        <div class="form-group">
          <label class="form-label">Confirmer le mot de passe</label>
          <div class="input-wrapper">
            <span class="input-icon">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
              </svg>
            </span>
            <input [type]="showConfirmPassword ? 'text' : 'password'" class="form-input"
                   placeholder="Confirmez votre mot de passe"
                   formControlName="confirmPassword"
                   [class.error]="isInvalid('confirmPassword')"/>
            <button type="button" class="eye-btn" (click)="showConfirmPassword = !showConfirmPassword">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
          </div>
          <span *ngIf="isInvalid('confirmPassword')" class="error-msg">Ce champ est requis</span>
        </div>
        </form>

        <button class="btn-full btn-bordeaux mt-2" (click)="resetPassword()" [disabled]="isLoading">
          <div *ngIf="isLoading" class="spinner"></div>
          <ng-container *ngIf="!isLoading">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Réinitialiser le mot de passe
          </ng-container>
        </button>
      </div>

      <!-- ══ ÉTAPE 4 : SUCCÈS ══ -->
      <div *ngIf="currentStep === 4" class="register-card text-center">
        <img src="assets/images/logo.png" alt="DIY" class="h-10 w-auto object-contain mx-auto mb-8"/>

        <div class="success-ring">
          <svg class="w-10 h-10" fill="none" stroke="#4A7C7E" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>

        <h1 class="font-display font-bold text-[#1E1A16] mb-3" style="font-size:clamp(24px,4vw,32px)">
          Mot de passe modifié !
        </h1>
        <p class="text-[#6B5F52] text-sm mb-8">
          Votre mot de passe a été réinitialisé avec succès.<br>
          Vous allez être redirigé vers la connexion...
        </p>

        <div class="countdown-badge mb-6">
          Redirection automatique dans quelques secondes...
        </div>

        <button class="btn-full btn-teal-full" (click)="goToLogin()">
          Se connecter maintenant
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
          </svg>
        </button>
      </div>

    </div>
  </div>

  <footer class="py-5 text-center border-t border-[#EDE8DF]">
    <p class="text-[#C8BEB2] text-xs">© {{ 2026 }} Digital Is Yours · Tous droits réservés</p>
  </footer>

</div>